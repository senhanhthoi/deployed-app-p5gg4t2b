
name: Build and Deploy API

on: [push]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: |
          docker build -t deployed-app-p5gg4t2b-image .
          echo "Docker image deployed-app-p5gg4t2b-image built successfully."
          echo "The Docker container should be configured to run the API, Cloudflare tunnel, and monitoring scripts as per project requirements."
      
      - name: Start the API container with Cloudflare Tunnel
        run: |
          # Run the container which will start both the API and Cloudflare tunnel
          docker run -d -p 8080:8080 --name api-container deployed-app-p5gg4t2b-image
          
          # Wait for container to initialize
          sleep 45
          
          # Check container logs to see if tunnel was established
          echo "Container logs:"
          docker logs api-container
          
          # Check if we can extract the Cloudflare tunnel URL from logs
          TUNNEL_URL=$(docker logs api-container 2>&1 | grep -o 'https://[a-zA-Z0-9.-]*\.trycloudflare\.com' | tail -1)
          if [ -n "$TUNNEL_URL" ]; then
            echo "::notice::Your application is available at: $TUNNEL_URL"
            echo "TUNNEL_URL=$TUNNEL_URL" >> $GITHUB_ENV
            
            # Update repository status in database
            echo "Updating repository status in database..."
            # Create JSON payload directly with variables
            curl -X POST \
              -H "Content-Type: application/json" \
              -d '{"repository_name":"deployed-app-p5gg4t2b","status":"Active","cloudflare_tunnel_url":"'$TUNNEL_URL'"}' \
              -s "https://update-repository-status.vercel.app/api/update_repository_status"
              
            echo "::notice::Repository status updated in database"
          else
            echo "::warning::Could not extract Cloudflare tunnel URL from logs"
          fi
